<div class="container">
  <div class="card shadow-sm border-0 overflow-hidden mb-4">
    <div class="card-body p-4">
      <div class="d-flex align-items-center gap-3 mb-3">
        <% initials = @person.name.to_s.split.map { |w| w[0] }.join.first(2).upcase %>
        <div class="avatar avatar-xl bg-gradient rounded-circle d-inline-flex justify-content-center align-items-center text-white fw-bold">
          <%= image_tag @person.image, class: "avatar" %>
        </div>

        <div class="flex-grow-1">
          <h1 class="h3 mb-1"><%= @person.name %></h1>
          <% if @person.updated_at %>
            <div class="text-muted small">Last updated <%= time_ago_in_words(@person.updated_at) %> ago</div>
          <% end %>
        </div>

        <div class="d-none d-md-flex gap-2">
          <%= link_to "Start New Chat", new_person_chat_path(@person), class: "btn btn-warning" rescue nil %>
        </div>
      </div>
    </div>
  </div>

  <div class="content">
    <div class="messages-list">
      <% if @chat.messages.any? %>
        <% @chat.messages.each do |message| %>
          <div class="d-flex <%= 'justify-content-end' if message.role == 'user' %> <%= 'justify-content-start' if message.role == 'bot' %> mb-2">
            <div class="message <%= 'user-message' if message.role == 'user' %> <%= 'bot-message' if message.role == 'bot' %>"
              style="
                background-color: <%= message.role == 'user' ? '#d8ecff' : '#f1f1f1' %>;
                border-radius: 12px;
                padding: 10px;
                max-width: 70%;">
              <div class="message-body">
                <%= message.content %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <p>No chats found for this person. Start a new one!</p>
      <% end %>
    </div>
  </div>

  <div class="message-form mt-3">
    <%= form_with(model: [@person, @chat, @message], local: true) do |f| %>
      <div class="input-group">
        <%= f.text_field :content, placeholder: "Type a message...", class: "form-control border-1 me-2" %>
        <button class="btn btn-warning" type="submit">Send</button>
      </div>
    <% end %>
  </div>

  <div class="footer d-flex justify-content-center mt-4 gap-3">
    <%= link_to "Go Back", person_path(@person), class: "btn border" %>
    <%= button_to "Delete", chat_path(@chat),
        method: :delete,
        data: { turbo_confirm: "Are you sure you want to delete this chat?" },
        class: "btn border" %>
  </div>
</div>
